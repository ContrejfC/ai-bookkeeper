<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bookkeeper - Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .company-selector {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 6px;
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-filter select, .date-filter input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #343a40;
            margin-bottom: 5px;
        }
        
        .metric-value.success {
            color: #28a745;
        }
        
        .metric-value.warning {
            color: #ffc107;
        }
        
        .metric-value.danger {
            color: #dc3545;
        }
        
        .metric-target {
            font-size: 12px;
            color: #6c757d;
        }
        
        .metric-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #343a40;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📊 AI Bookkeeper Dashboard</h1>
            <p class="subtitle">Real-time automation metrics & financial reports</p>
        </header>
        
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="date-filter">
                    <label>Period:</label>
                    <select id="periodSelect" onchange="loadDashboard()">
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                    
                    <label>Start:</label>
                    <input type="date" id="startDate" onchange="loadDashboard()">
                    
                    <label>End:</label>
                    <input type="date" id="endDate" onchange="loadDashboard()">
                </div>
                
                <button class="btn btn-primary" onclick="loadDashboard()">🔄 Refresh</button>
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="loading" class="loading">
                <p>Loading dashboard data...</p>
            </div>
            
            <div id="dashboardContent" style="display: none;">
                <!-- KPI Cards -->
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be populated here -->
                </div>
                
                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Automation Rate Trend</div>
                        <div class="chart-container">
                            <canvas id="automationTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">P&L Overview</div>
                        <div class="chart-container">
                            <canvas id="pnlChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">Cash Balance Trend</div>
                        <div class="chart-container">
                            <canvas id="cashChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">Transaction Volume</div>
                        <div class="chart-container">
                            <canvas id="volumeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const COMPANY_ID = 'demo_company_001';  // TODO: Get from auth token
        
        // Chart instances
        let charts = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadDashboard();
        });
        
        function setDefaultDates() {
            const today = new Date();
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setDate(today.getDate() - 90);
            
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = ninetyDaysAgo;
        }
        
        async function loadDashboard() {
            showLoading();
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const days = document.getElementById('periodSelect').value;
                
                // Load all data in parallel
                const [metrics, pnl, cashflow] = await Promise.all([
                    fetchAutomationMetrics(days),
                    fetchPnL(startDate, endDate),
                    fetchCashFlow(startDate, endDate)
                ]);
                
                // Render dashboard
                renderMetrics(metrics);
                renderAutomationTrend(metrics);
                renderPnLChart(pnl);
                renderCashChart(cashflow);
                renderVolumeChart(metrics);
                
                showDashboard();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function fetchAutomationMetrics(days) {
            const response = await fetch(`/api/analytics/automation-metrics?company_id=${COMPANY_ID}&days=${days}`);
            if (!response.ok) throw new Error('Failed to fetch automation metrics');
            return await response.json();
        }
        
        async function fetchPnL(startDate, endDate) {
            const response = await fetch(`/api/analytics/pnl?company_id=${COMPANY_ID}&start_date=${startDate}&end_date=${endDate}`);
            if (!response.ok) throw new Error('Failed to fetch P&L');
            return await response.json();
        }
        
        async function fetchCashFlow(startDate, endDate) {
            const response = await fetch(`/api/analytics/cashflow?company_id=${COMPANY_ID}&start_date=${startDate}&end_date=${endDate}`);
            if (!response.ok) throw new Error('Failed to fetch cash flow');
            return await response.json();
        }
        
        function renderMetrics(metrics) {
            const grid = document.getElementById('metricsGrid');
            grid.innerHTML = '';
            
            // Auto-Approval Rate
            grid.innerHTML += createMetricCard(
                '🤖 Auto-Approval Rate',
                `${metrics.rates.auto_approval_rate}%`,
                `Target: ${metrics.targets.auto_approval_target}%`,
                metrics.status.auto_approval_met ? 'success' : 'warning'
            );
            
            // Recon Match Rate
            grid.innerHTML += createMetricCard(
                '✅ Recon Match Rate',
                `${metrics.rates.recon_match_rate}%`,
                `Target: ${metrics.targets.recon_match_target}%`,
                metrics.status.recon_match_met ? 'success' : 'warning'
            );
            
            // Manual Review Rate
            grid.innerHTML += createMetricCard(
                '👁️ Manual Review Rate',
                `${metrics.rates.review_rate}%`,
                `Target: <${metrics.targets.review_target_max}%`,
                metrics.status.review_met ? 'success' : 'danger'
            );
            
            // Transactions Processed
            grid.innerHTML += createMetricCard(
                '📈 Transactions',
                metrics.transactions.total,
                `${metrics.transactions.matched} matched`,
                ''
            );
        }
        
        function createMetricCard(label, value, target, colorClass) {
            return `
                <div class="metric-card">
                    <div class="metric-label">${label}</div>
                    <div class="metric-value ${colorClass}">${value}</div>
                    <div class="metric-target">${target}</div>
                </div>
            `;
        }
        
        function renderAutomationTrend(metrics) {
            destroyChart('automationTrendChart');
            
            const ctx = document.getElementById('automationTrendChart').getContext('2d');
            
            // Generate sample trend data (in production, fetch from /api/analytics/automation-trend)
            const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const data = [75, 78, 82, metrics.rates.auto_approval_rate];
            
            charts.automationTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Auto-Approval %',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderPnLChart(pnl) {
            destroyChart('pnlChart');
            
            const ctx = document.getElementById('pnlChart').getContext('2d');
            
            charts.pnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Revenue', 'Expenses', 'Net Income'],
                    datasets: [{
                        data: [
                            pnl.revenue.total,
                            pnl.expenses.total,
                            pnl.net_income
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545',
                            pnl.net_income >= 0 ? '#667eea' : '#ffc107'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCashChart(cashflow) {
            destroyChart('cashChart');
            
            const ctx = document.getElementById('cashChart').getContext('2d');
            
            charts.cashChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Beginning', 'Operations', 'Investing', 'Financing', 'Ending'],
                    datasets: [{
                        label: 'Cash Balance',
                        data: [
                            cashflow.beginning_cash,
                            cashflow.beginning_cash + cashflow.operating_activities.total,
                            cashflow.beginning_cash + cashflow.operating_activities.total + cashflow.investing_activities.total,
                            cashflow.ending_cash - cashflow.financing_activities.total,
                            cashflow.ending_cash
                        ],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderVolumeChart(metrics) {
            destroyChart('volumeChart');
            
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            charts.volumeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Auto-Approved', 'Needs Review', 'Posted'],
                    datasets: [{
                        data: [
                            metrics.journal_entries.auto_approved,
                            metrics.journal_entries.needs_review,
                            metrics.journal_entries.posted
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#667eea'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'Error: ' + message;
        }
    </script>
</body>
</html>

