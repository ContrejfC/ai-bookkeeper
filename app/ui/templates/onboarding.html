{% extends "base.html" %}

{% block title %}Onboarding - AI Bookkeeper{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-4xl" x-data="onboardingWizard()">
    <h1 class="text-3xl font-bold mb-6">Welcome to AI Bookkeeper</h1>
    
    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium" :class="currentStep >= 1 ? 'text-indigo-600' : 'text-gray-400'">1. Chart of Accounts</span>
            <span class="text-sm font-medium" :class="currentStep >= 2 ? 'text-indigo-600' : 'text-gray-400'">2. Data Ingest</span>
            <span class="text-sm font-medium" :class="currentStep >= 3 ? 'text-indigo-600' : 'text-gray-400'">3. Safety Settings</span>
            <span class="text-sm font-medium" :class="currentStep >= 4 ? 'text-indigo-600' : 'text-gray-400'">4. Tips & Finish</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" 
                 :style="`width: ${(currentStep / 4) * 100}%`"></div>
        </div>
    </div>
    
    <!-- Step 1: Chart of Accounts -->
    <div x-show="currentStep === 1" class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold mb-4">Chart of Accounts</h2>
        <p class="text-gray-600 mb-6">Choose how to set up your accounts:</p>
        
        <div class="space-y-4">
            <!-- Template Selection -->
            <div class="border rounded p-4">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" x-model="coaMethod" value="template" class="mr-3">
                    <div>
                        <span class="font-medium">Use a Template</span>
                        <p class="text-sm text-gray-500">Quick start with industry-standard accounts</p>
                    </div>
                </label>
                
                <div x-show="coaMethod === 'template'" class="mt-4 ml-7">
                    <select x-model="coaTemplate" class="w-full border rounded px-3 py-2">
                        <option value="">Select template...</option>
                        <option value="standard_small_business">Standard Small Business</option>
                        <option value="professional_services">Professional Services</option>
                        <option value="gaap_accounting_firm">GAAP Accounting Firm</option>
                    </select>
                </div>
            </div>
            
            <!-- Upload CSV -->
            <div class="border rounded p-4">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" x-model="coaMethod" value="upload" class="mr-3">
                    <div>
                        <span class="font-medium">Upload CSV</span>
                        <p class="text-sm text-gray-500">Import your existing chart of accounts</p>
                    </div>
                </label>
                
                <div x-show="coaMethod === 'upload'" class="mt-4 ml-7">
                    <input type="file" @change="handleCoaUpload" accept=".csv" class="w-full">
                    <p class="text-xs text-gray-500 mt-2">CSV format: account_code, account_name, account_type</p>
                </div>
            </div>
        </div>
        
        <div class="mt-6 flex justify-between">
            <button @click="resumeLater()" class="text-gray-600 hover:text-gray-800">Resume Later</button>
            <button @click="nextStep()" :disabled="!canProceedStep1()" 
                    class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
    
    <!-- Step 2: Data Ingest -->
    <div x-show="currentStep === 2" class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold mb-4">Import Your Data</h2>
        <p class="text-gray-600 mb-6">Upload your historical transactions and receipts:</p>
        
        <div class="space-y-6">
            <!-- Transactions -->
            <div class="border rounded p-4">
                <h3 class="font-medium mb-2">Transactions</h3>
                <p class="text-sm text-gray-500 mb-3">CSV or OFX format (last 6-12 months recommended)</p>
                <input type="file" @change="handleTransactionsUpload" accept=".csv,.ofx,.qfx" class="w-full">
                <p x-show="transactionsFile" class="text-sm text-green-600 mt-2">
                    ‚úì <span x-text="transactionsFile?.name"></span>
                </p>
            </div>
            
            <!-- Receipts -->
            <div class="border rounded p-4">
                <h3 class="font-medium mb-2">Receipts (Optional)</h3>
                <p class="text-sm text-gray-500 mb-3">PDF or TXT files</p>
                <input type="file" @change="handleReceiptsUpload" accept=".pdf,.txt" multiple class="w-full">
                <p x-show="receiptsFiles.length > 0" class="text-sm text-green-600 mt-2">
                    ‚úì <span x-text="receiptsFiles.length"></span> files selected
                </p>
            </div>
        </div>
        
        <div class="mt-6 flex justify-between">
            <button @click="prevStep()" class="text-gray-600 hover:text-gray-800">Back</button>
            <button @click="nextStep()" :disabled="!canProceedStep2()"
                    class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
    
    <!-- Step 3: Safety Settings -->
    <div x-show="currentStep === 3" class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold mb-4">Safety Settings</h2>
        <p class="text-gray-600 mb-6">Configure guardrails for automated processing:</p>
        
        <div class="space-y-6">
            <!-- Auto-Post Threshold -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Confidence Threshold for Auto-Post
                </label>
                <div class="flex items-center gap-4">
                    <input type="range" x-model.number="autopostThreshold" min="0.80" max="0.98" step="0.01" class="flex-1">
                    <span class="font-mono text-lg" x-text="autopostThreshold.toFixed(2)"></span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Recommended: 0.90 (only very confident categorizations auto-post)</p>
            </div>
            
            <!-- LLM Budget -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Monthly LLM Budget (USD)
                </label>
                <input type="number" x-model.number="llmBudget" min="10" max="500" step="10" 
                       class="w-full border rounded px-3 py-2">
                <p class="text-sm text-gray-500 mt-1">Default: $50/month (system falls back to Rules/ML if exceeded)</p>
            </div>
            
            <!-- Auto-Post Confirmation -->
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="autopostDisabled" disabled checked class="mr-3">
                    <div>
                        <span class="font-medium text-yellow-800">Auto-Post is DISABLED by default</span>
                        <p class="text-sm text-yellow-700">Review all transactions manually before enabling auto-post</p>
                    </div>
                </label>
            </div>
        </div>
        
        <div class="mt-6 flex justify-between">
            <button @click="prevStep()" class="text-gray-600 hover:text-gray-800">Back</button>
            <button @click="nextStep()"
                    class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                Next
            </button>
        </div>
    </div>
    
    <!-- Step 4: Tips & Finish -->
    <div x-show="currentStep === 4" class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold mb-4">You're All Set!</h2>
        <p class="text-gray-600 mb-6">Here are some tips to get started:</p>
        
        <div class="space-y-4 mb-6">
            <div class="flex items-start">
                <span class="text-2xl mr-3">‚å®Ô∏è</span>
                <div>
                    <h3 class="font-medium">Keyboard Shortcuts</h3>
                    <ul class="text-sm text-gray-600 mt-1">
                        <li><kbd class="px-2 py-1 bg-gray-100 rounded">A</kbd> - Approve transaction</li>
                        <li><kbd class="px-2 py-1 bg-gray-100 rounded">R</kbd> - Reject transaction</li>
                        <li><kbd class="px-2 py-1 bg-gray-100 rounded">E</kbd> - View explanation</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex items-start">
                <span class="text-2xl mr-3">üéØ</span>
                <div>
                    <h3 class="font-medium">Shadow Mode</h3>
                    <p class="text-sm text-gray-600">Review AI suggestions without auto-posting. System learns from your corrections.</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <span class="text-2xl mr-3">üìä</span>
                <div>
                    <h3 class="font-medium">Monitor Performance</h3>
                    <p class="text-sm text-gray-600">Check /metrics to track automation rate and accuracy.</p>
                </div>
            </div>
        </div>
        
        <div x-show="submitting" class="text-center py-4">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-gray-600">Setting up your account...</p>
        </div>
        
        <div x-show="!submitting" class="mt-6 flex justify-between">
            <button @click="prevStep()" class="text-gray-600 hover:text-gray-800">Back</button>
            <button @click="finishOnboarding()"
                    class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 text-lg font-semibold">
                Start Reviewing Transactions ‚Üí
            </button>
        </div>
    </div>
    
    <!-- Error Messages -->
    <div x-show="errorMessage" 
         x-text="errorMessage"
         class="mt-4 p-4 bg-red-100 border border-red-200 text-red-800 rounded">
    </div>
</div>

<script>
function onboardingWizard() {
    return {
        currentStep: 1,
        coaMethod: '',
        coaTemplate: '',
        coaFile: null,
        transactionsFile: null,
        receiptsFiles: [],
        autopostThreshold: 0.90,
        llmBudget: 50,
        autopostDisabled: true,
        submitting: false,
        errorMessage: '',
        
        canProceedStep1() {
            if (this.coaMethod === 'template') {
                return this.coaTemplate !== '';
            }
            if (this.coaMethod === 'upload') {
                return this.coaFile !== null;
            }
            return false;
        },
        
        canProceedStep2() {
            return this.transactionsFile !== null;
        },
        
        handleCoaUpload(event) {
            this.coaFile = event.target.files[0];
        },
        
        handleTransactionsUpload(event) {
            this.transactionsFile = event.target.files[0];
        },
        
        handleReceiptsUpload(event) {
            this.receiptsFiles = Array.from(event.target.files);
        },
        
        nextStep() {
            if (this.currentStep < 4) {
                this.currentStep++;
            }
        },
        
        prevStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
            }
        },
        
        async resumeLater() {
            // Save progress to localStorage
            localStorage.setItem('onboarding_progress', JSON.stringify({
                step: this.currentStep,
                coaMethod: this.coaMethod,
                coaTemplate: this.coaTemplate,
                autopostThreshold: this.autopostThreshold,
                llmBudget: this.llmBudget
            }));
            
            alert('Progress saved. You can resume onboarding later.');
            window.location.href = '/';
        },
        
        async finishOnboarding() {
            this.submitting = true;
            this.errorMessage = '';
            
            try {
                // Prepare FormData for file uploads
                const formData = new FormData();
                formData.append('coa_method', this.coaMethod);
                formData.append('coa_template', this.coaTemplate);
                formData.append('autopost_threshold', this.autopostThreshold);
                formData.append('llm_budget', this.llmBudget);
                
                if (this.coaFile) {
                    formData.append('coa_file', this.coaFile);
                }
                if (this.transactionsFile) {
                    formData.append('transactions_file', this.transactionsFile);
                }
                this.receiptsFiles.forEach((file, index) => {
                    formData.append('receipts', file);
                });
                
                const response = await fetch('/api/onboarding/complete', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Clear saved progress
                    localStorage.removeItem('onboarding_progress');
                    // Redirect to review
                    window.location.href = `/review?tenant_id=${data.tenant_id}`;
                } else {
                    const error = await response.json();
                    this.errorMessage = error.detail || 'Onboarding failed. Please try again.';
                    this.submitting = false;
                }
            } catch (error) {
                console.error('Onboarding error:', error);
                this.errorMessage = 'Network error. Please check your connection and try again.';
                this.submitting = false;
            }
        },
        
        init() {
            // Resume from saved progress
            const saved = localStorage.getItem('onboarding_progress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    this.currentStep = progress.step || 1;
                    this.coaMethod = progress.coaMethod || '';
                    this.coaTemplate = progress.coaTemplate || '';
                    this.autopostThreshold = progress.autopostThreshold || 0.90;
                    this.llmBudget = progress.llmBudget || 50;
                } catch (e) {
                    console.error('Error loading saved progress:', e);
                }
            }
        }
    }
}
</script>
{% endblock %}

