name: Deploy to Staging

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: false

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt pytest
      
      - name: Run tests
        env:
          DATABASE_URL: sqlite:///./test.db
          JWT_SECRET: test-secret
          AUTH_MODE: dev
        run: pytest -q

  build-and-deploy:
    name: Build & Deploy to Staging
    runs-on: ubuntu-latest
    needs: [tests]
    if: always() && (needs.tests.result == 'success' || github.event.inputs.skip_tests == 'true')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t ai-bookkeeper:staging -f Dockerfile .
      
      - name: Save Docker image
        run: docker save ai-bookkeeper:staging | gzip > staging-image.tar.gz
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: staging-docker-image
          path: staging-image.tar.gz
          retention-days: 7
      
      # Render deployment (if using Render)
      - name: Trigger Render Deploy
        if: env.RENDER_DEPLOY_HOOK_URL != ''
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: curl -X POST "$RENDER_DEPLOY_HOOK_URL"
      
      # Cloud Run deployment (if using GCP)
      - name: Deploy to Cloud Run
        if: env.GCP_PROJECT_ID != ''
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "Cloud Run deployment would go here"
          echo "gcloud run deploy --image gcr.io/$GCP_PROJECT_ID/ai-bookkeeper:staging"

  smoke-test:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Run smoke test
        env:
          STAGING_URL: ${{ secrets.STAGING_API_URL || 'https://staging-api.ai-bookkeeper.app' }}
        run: |
          chmod +x scripts/e2e_selfserve.sh
          ./scripts/e2e_selfserve.sh "$STAGING_URL"
      
      - name: Upload smoke test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-artifacts
          path: /tmp/aibk_selfserve/
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Staging smoke test failed. Check artifacts for details."
          echo "Rollback: See docs/DEPLOY.md for rollback instructions"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ STAGING DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Tests: ${{ needs.tests.result }}"
          echo "Build: ${{ needs.build-and-deploy.result }}"
          echo "Smoke Test: ${{ needs.smoke-test.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

