{% extends "base.html" %}

{% block title %}Analytics - AI Bookkeeper{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-7xl" x-data="analyticsViewer()">
    <div class="mb-6">
        <h1 class="text-3xl font-bold">Product Analytics</h1>
        <p class="text-gray-600">Last 7 days event summaries</p>
    </div>
    
    <!-- Summary Cards -->
    <div x-show="reports.length > 0" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-sm text-gray-600">Total Events</div>
            <div class="text-3xl font-bold text-indigo-600" x-text="totalEvents"></div>
            <div class="text-xs text-gray-500 mt-1">Last 7 days</div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-sm text-gray-600">Active Tenants</div>
            <div class="text-3xl font-bold text-green-600" x-text="uniqueTenants.size"></div>
            <div class="text-xs text-gray-500 mt-1">Unique tenants</div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-sm text-gray-600">Page Views</div>
            <div class="text-3xl font-bold text-blue-600" x-text="pageViews"></div>
            <div class="text-xs text-gray-500 mt-1">All pages</div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-sm text-gray-600">Reviews</div>
            <div class="text-3xl font-bold text-purple-600" x-text="reviewActions"></div>
            <div class="text-xs text-gray-500 mt-1">Approve + Reject</div>
        </div>
    </div>
    
    <!-- Daily Reports -->
    <div class="space-y-4">
        <template x-for="report in reports" :key="report.date">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold" x-text="formatDate(report.date)"></h2>
                        <div class="text-sm text-gray-600">
                            <span x-text="report.summary?.total_events || 0"></span> events ‚Ä¢
                            <span x-text="report.summary?.unique_tenants || 0"></span> tenants
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Event Totals Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-sm text-gray-600">Page Views</div>
                            <div class="text-2xl font-bold" x-text="report.totals?.page_view || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-green-50 rounded-lg">
                            <div class="text-sm text-gray-600">Approvals</div>
                            <div class="text-2xl font-bold" x-text="report.totals?.review_action_approve || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <div class="text-sm text-gray-600">Rejections</div>
                            <div class="text-2xl font-bold" x-text="report.totals?.review_action_reject || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <div class="text-sm text-gray-600">Exports</div>
                            <div class="text-2xl font-bold" x-text="(report.totals?.export_run_posted || 0) + (report.totals?.export_run_skipped || 0)"></div>
                        </div>
                    </div>
                    
                    <!-- Per-Tenant Breakdown -->
                    <div x-show="report.by_tenant && Object.keys(report.by_tenant).length > 0">
                        <h3 class="font-semibold text-gray-700 mb-3">By Tenant</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="(events, tenantId) in report.by_tenant" :key="tenantId">
                                <div class="border rounded p-4">
                                    <div class="font-medium text-gray-900 mb-2" x-text="tenantId"></div>
                                    <div class="space-y-1 text-sm">
                                        <template x-for="(count, eventType) in events" :key="eventType">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600" x-text="formatEventType(eventType)"></span>
                                                <span class="font-medium" x-text="count"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Sample Data Notice -->
                    <div x-show="report.note" class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            ‚ÑπÔ∏è <span x-text="report.note"></span>
                        </p>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Empty State -->
    <div x-show="reports.length === 0 && !loading" class="bg-white rounded-lg shadow p-12 text-center">
        <div class="text-gray-400 text-5xl mb-4">üìä</div>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Analytics Data Yet</h3>
        <p class="text-gray-600">Events will appear here as users interact with the system.</p>
    </div>
    
    <!-- Loading State -->
    <div x-show="loading" class="bg-white rounded-lg shadow p-12 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading analytics...</p>
    </div>
</div>

<script>
function analyticsViewer() {
    return {
        reports: [],
        loading: false,
        totalEvents: 0,
        pageViews: 0,
        reviewActions: 0,
        uniqueTenants: new Set(),
        
        async init() {
            await this.loadReports();
            this.calculateSummaries();
        },
        
        async loadReports() {
            this.loading = true;
            try {
                const response = await fetch('/api/analytics/last7');
                this.reports = await response.json();
            } catch (error) {
                console.error('Error loading analytics:', error);
                this.reports = [];
            } finally {
                this.loading = false;
            }
        },
        
        calculateSummaries() {
            this.totalEvents = 0;
            this.pageViews = 0;
            this.reviewActions = 0;
            this.uniqueTenants = new Set();
            
            this.reports.forEach(report => {
                this.totalEvents += (report.summary?.total_events || 0);
                this.pageViews += (report.totals?.page_view || 0);
                this.reviewActions += (report.totals?.review_action_approve || 0) + (report.totals?.review_action_reject || 0);
                
                if (report.by_tenant) {
                    Object.keys(report.by_tenant).forEach(tenant => {
                        this.uniqueTenants.add(tenant);
                    });
                }
            });
        },
        
        formatDate(dateStr) {
            // Format YYYY-MM-DD to readable date
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        },
        
        formatEventType(eventType) {
            // Convert snake_case to Title Case
            return eventType
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    }
}
</script>
{% endblock %}

